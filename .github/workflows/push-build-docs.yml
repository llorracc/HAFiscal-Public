name: Push Document Build

on:
  push:
    branches: [ main, master, 20250612_finish-latexmk-fixes ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: push-docs-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-docs:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    env:
      ACTIONS_STEP_DEBUG: true
      ACTIONS_RUNNER_DEBUG: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install TeX Live and latexmk
        run: |
          echo "=== Installing TeX Live packages ==="
          sudo apt-get update
          sudo apt-get install -y \
            latexmk \
            texlive-latex-base \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-fonts-extra \
            texlive-science \
            texlive-bibtex-extra \
            biber \
            ghostscript
          echo "TeX Live installation completed"

      - name: Set up LaTeX package paths
        run: |
          echo "=== Setting up LaTeX package paths ==="
          # Add local texmf directory to TEXINPUTS so LaTeX can find econark packages
          export TEXINPUTS="${GITHUB_WORKSPACE}/@resources/texlive/texmf-local/tex/latex//:${TEXINPUTS:-}"
          echo "TEXINPUTS=${TEXINPUTS}" >> $GITHUB_ENV
          echo "LaTeX package paths configured"

      - name: Build PDFs
        env:
          LATEX_OPTS: "-interaction=nonstopmode"
        run: |
          echo "=== Building PDFs ==="
          bash reproduce/reproduce_documents.sh
          echo "PDF build completed"

      - name: Upload PDFs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: PDFs
          if-no-files-found: ignore
          path: |
            HAFiscal.pdf
            HAFiscal-online-appendix.pdf
            HAFiscal-Slides.pdf

      - name: Check for docs directory changes
        id: docs-changes
        run: |
          echo "=== Checking for docs directory changes ==="
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q '^docs/'; then
            echo "docs_changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected in docs/ directory"
          else
            echo "docs_changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes in docs/ directory"
          fi

      - name: Setup GitHub Pages
        if: steps.docs-changes.outputs.docs_changed == 'true'
        uses: actions/configure-pages@v4

      - name: Upload docs to GitHub Pages
        if: steps.docs-changes.outputs.docs_changed == 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

      - name: Deploy to GitHub Pages
        if: steps.docs-changes.outputs.docs_changed == 'true'
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Pages deployment summary
        if: steps.docs-changes.outputs.docs_changed == 'true'
        run: |
          echo "ðŸŒ GitHub Pages deployed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ Deployed from: \`docs/\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— URL: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
